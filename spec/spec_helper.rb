require 'rspec'
require_relative File.join('..', 'lib', 'cve_crawler')

class CrawlerResultMock
  def xml_full
    <<-eos
<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://purl.org/rss/1.0/" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel rdf:about="http://web.nvd.nist.gov/view/vuln/search">
    <title>National Vulnerability Database</title>
    <link>http://web.nvd.nist.gov/view/vuln/search</link>
    <description>This feed contains the most recent CVE cyber vulnerabilities published within the National Vulnerability Database.</description>
    <items>
      <rdf:Seq>
        <rdf:li rdf:resource="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4476" />
        <rdf:li rdf:resource="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4500" />
        <rdf:li rdf:resource="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4501" />
     </rdf:Seq>
    </items>
    <dc:date>2015-09-27T04:50:00Z</dc:date>
    <dc:language>en-us</dc:language>
    <dc:rights>This material is not copywritten and may be freely used, however, attribution is requested.</dc:rights>
  </channel>
  <item rdf:about="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4476">
    <title>CVE-2015-4476 (firefox)</title>
    <link>http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4476</link>
    <description>Mozilla Firefox before 41.0 on Android allows user-assisted remote attackers to spoof address-bar attributes by leveraging lack of navigation after a paste of a URL with a nonstandard scheme, as demonstrated by spoofing an SSL attribute.</description>
    <dc:date>2015-09-24T04:59:00Z</dc:date>
  </item>
  <item rdf:about="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4500">
    <title>CVE-2015-4500 (firefox, firefox_esr)</title>
    <link>http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4500</link>
    <description>Multiple unspecified vulnerabilities in the browser engine in Mozilla Firefox before 41.0 and Firefox ESR 38.x before 38.3 allow remote attackers to cause a denial of service (memory corruption and application crash) or possibly execute arbitrary code via unknown vectors.</description>
    <dc:date>2015-09-24T04:59:02Z</dc:date>
  </item>
  <item rdf:about="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4501">
    <title>CVE-2015-4501 (firefox)</title>
    <link>http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-4501</link>
    <description>Multiple unspecified vulnerabilities in the browser engine in Mozilla Firefox before 41.0 allow remote attackers to cause a denial of service (memory corruption and application crash) or possibly execute arbitrary code via unknown vectors.</description>
    <dc:date>2015-09-24T04:59:03Z</dc:date>
  </item>
</rdf:RDF>
    eos
  end
end

class VulnerabilityMock
  def self.generate
    mocker = VulnerabilityMock.new
    id = mocker.identifier

    CVE::Vulnerability.new({
      :identifier => id,
      :title => mocker.title(id),
      :link => mocker.link(id),
      :description => mocker.description,
      :date => mocker.date
    })
  end

  def identifier
    year = Time.now.year
    "CVE-#{rand(2000..year)}-#{rand(0..9999)}"
  end

  def title(id=nil)
    (id || identifier) + ' (' + ['Lorem Ipsum', 'Some vulnerability', 'Your favourite software',
      'Firefox', 'Chromium', 'Thunderbird'].sample.split('').shuffle.join + ')'
  end

  def link(id=nil)
    'http://web.nvd.nist.gov/view/vuln/detail?vulnId=' + (id || identifier)
  end

  def description
    ['Hakuna Matata', 'What a wonderful phrase', 'Ain\'t no passing phrase', 'It means no worries',
      'for the rest of your days', 'It\'s our problem-free philosophy', 'Yeah. That\'s our motto',
      'What\'s a motto?'].sample.split('').shuffle.join
  end

  def date
    Time.now
  end
end
